From 76082570b8115c3410bac42bb5842ba201dddb76 Mon Sep 17 00:00:00 2001
From: Ronny Chevalier <chevalier.ronny@gmail.com>
Date: Thu, 18 Sep 2014 12:09:10 +0200
Subject: [PATCH] tests: fix resource & mem leaks

---
 src/test/test-condition-util.c | 2 +-
 src/test/test-fileio.c         | 9 ++++-----
 2 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/src/test/test-condition-util.c b/src/test/test-condition-util.c
index 4ee5600ff6..35ee9167bf 100644
--- a/src/test/test-condition-util.c
+++ b/src/test/test-condition-util.c
@@ -45,7 +45,7 @@ static void test_condition_test_host(void) {
         sd_id128_t id;
         int r;
         char sid[SD_ID128_STRING_MAX];
-        char *hostname;
+        _cleanup_free_ char *hostname = NULL;
 
         r = sd_id128_get_machine(&id);
         assert_se(r >= 0);
diff --git a/src/test/test-fileio.c b/src/test/test-fileio.c
index 92aa794a95..1b99828191 100644
--- a/src/test/test-fileio.c
+++ b/src/test/test-fileio.c
@@ -303,7 +303,7 @@ static void test_write_string_stream(void) {
         assert_se(f);
         assert_se(write_string_stream(f, "boohoo") < 0);
 
-        f = fdopen(fd, "r+");
+        f = freopen(fn, "r+", f);
         assert_se(f);
 
         assert_se(write_string_stream(f, "boohoo") == 0);
@@ -317,8 +317,8 @@ static void test_write_string_stream(void) {
 
 static void test_write_string_file(void) {
         char fn[] = "/tmp/test-write_string_file-XXXXXX";
-        int fd;
-        char buf[64] = {0};
+        char buf[64] = {};
+        _cleanup_close_ int fd;
 
         fd = mkostemp_safe(fn, O_RDWR);
         assert_se(fd >= 0);
@@ -334,8 +334,7 @@ static void test_write_string_file(void) {
 static void test_sendfile_full(void) {
         char in_fn[] = "/tmp/test-sendfile_full-XXXXXX";
         char out_fn[] = "/tmp/test-sendfile_full-XXXXXX";
-        _cleanup_close_ int in_fd = -1;
-        int out_fd;
+        _cleanup_close_ int in_fd, out_fd;
         char text[] = "boohoo\nfoo\n\tbar\n";
         char buf[64] = {0};
 
